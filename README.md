# Stripe MRR Dashboard Pipeline

A complete pipeline for generating, extracting, transforming, and visualizing Monthly Recurring Revenue (MRR) data for a digital signage SaaS company.

## Architecture

```
Stripe Test Mode → generate_data.py (test clocks + snapshots)
                         ↓
                  config/sub_snapshots.json + config/current_run.json
                         ↓
                  extract_load.py (Stripe API + snapshots → BigQuery)
                         ↓
                  BigQuery Views (MRR, ARPPU, plan breakdowns)
                         ↓
                  FastAPI (port 8888)
                         ↓
                  React Dashboard (port 5173)
```

## Pipeline Steps

1. **Seed Prices** (`scripts/seed_prices.py`) — Creates 5 Stripe products and prices. Run once.
2. **Generate Data** (`scripts/generate_data.py`) — Creates 100 test customers using Stripe test clocks. Simulates 6 months of billing with upgrades, downgrades, and cancellations spread across each month. Saves monthly subscription snapshots to `config/sub_snapshots.json`.
3. **ETL Pipeline** (`etl/extract_load.py`) — Loads subscription snapshots into BigQuery, extracts raw invoices/subscriptions from Stripe for reference, and creates views for MRR, ARPPU, and plan breakdowns.
4. **API Server** (`api/main.py`) — FastAPI backend serving dashboard data from BigQuery.
5. **Dashboard** (`frontend/`) — Vite + React + TypeScript + Tailwind CSS + Recharts.

## Pricing Tiers

| Plan | Price | Screen Range |
|------|-------|-------------|
| Free | $0/screen/mo | 1–3 screens |
| Standard | $10/screen/mo | 2–8 screens |
| Pro Plus | $15/screen/mo | 5–20 screens |
| Engage | $30/screen/mo | 8–30 screens |
| Enterprise | $45/screen/mo | 25–100 screens |

## Customer Distribution

- 25 Free, 18 Standard, 32 Pro Plus, 15 Engage, 10 Enterprise (100 total)

## Simulated Lifecycle (over 6 months)

- **15 upgrades** — plan tier changes or screen count increases
- **2 downgrades** — plan tier decreases
- **8 cancellations** — weighted toward Free/Standard tiers

Changes are spread across all 6 months (1 advance per month) for realistic, gradual MRR growth.

## How MRR is Calculated

MRR is derived from **subscription snapshots**, not Stripe invoices. Each month, `generate_data.py` captures the exact state of every active subscription (plan, screen count, price). This avoids issues with Stripe's inconsistent invoice generation on test clocks and gives perfectly accurate, stable metrics.

## Prerequisites

- Python 3.12+
- Node.js 18+
- [uv](https://docs.astral.sh/uv/) (Python package manager)
- Stripe account (test mode)
- Google Cloud Platform account with BigQuery enabled

## Setup

### 1. Credentials

You need two files that are not in the repo (they contain secrets):

| File | What it is | How to get it |
|------|-----------|---------------|
| `.env` | Environment variables | Copy `.env.example` → `.env` and fill in values |
| `service-account.json` | GCP service account key | GCP Console → IAM & Admin → Service Accounts → Create Key → JSON |

```bash
cp .env.example .env
# Edit .env with your Stripe secret key and GCP project ID
# Place your GCP service account JSON file as service-account.json in the project root
```

The GCP service account needs these roles: **BigQuery Data Editor** + **BigQuery User**.

### 2. Install dependencies

```bash
uv sync
```

### 3. Run the pipeline

```bash
# Step 1: Create Stripe products and prices (run once)
uv run python scripts/seed_prices.py

# Step 2: Generate 100 test customers with 6 months of billing history
uv run python scripts/generate_data.py

# Step 3: Extract from Stripe, load snapshots to BigQuery, create views
uv run python etl/extract_load.py

# Step 4: Start the API server
uv run uvicorn api.main:app --port 8888 --reload

# Step 5: Start the dashboard (in another terminal)
cd frontend && npm install && npm run dev
```

### 4. Open the dashboard

Open [http://localhost:5173](http://localhost:5173) to view the dashboard.

## Dashboard Metrics

- **MRR Trend** — Monthly recurring revenue over time
- **Revenue by Plan** — MRR breakdown by pricing tier (stacked area chart)
- **ARPPU Trend** — Average Revenue Per Paying User
- **Customer Count** — Total and paying customers over time
- **Customers by Plan** — Customer count per tier per month (stacked bar chart)

## Key Config Files

| File | Generated by | Used by |
|------|-------------|---------|
| `config/stripe_prices.json` | `seed_prices.py` | `generate_data.py`, `extract_load.py` |
| `config/current_run.json` | `generate_data.py` | `extract_load.py` (filters to current run's customers) |
| `config/sub_snapshots.json` | `generate_data.py` | `extract_load.py` (source of truth for MRR) |

## Testing & Validation

The project includes automated tests to verify data integrity and cross-validate against Stripe's live API.

### How to run

```bash
# Run the full test suite
uv run python -m pytest tests/test_snapshots.py -v

# Run only offline integrity tests (no Stripe credentials needed)
uv run python -m pytest tests/test_snapshots.py -v -k "SnapshotIntegrity"

# Run only Stripe cross-validation tests (requires STRIPE_SECRET_KEY in .env)
uv run python -m pytest tests/test_snapshots.py -v -k "StripeCrossValidation"

# Or run the standalone validation script for a human-readable report
uv run python scripts/validate_mrr.py
```

### Test breakdown

**`SnapshotIntegrityTests`** — Offline checks against `config/sub_snapshots.json`. No Stripe credentials needed.

| Test | What it checks |
|------|----------------|
| `test_snapshots_not_empty` | Snapshot file has data |
| `test_mrr_cents_equals_price_times_screens` | `mrr_cents == price_amount * screens` for every row |
| `test_no_duplicate_customers_per_month` | Each customer appears at most once per month |
| `test_price_amount_matches_plan` | Price amounts match the known price for each plan tier |
| `test_screens_positive` | No row has 0 or negative screens |
| `test_all_months_present` | Exactly 7 months exist (month 0 + 6 advances) |

**`StripeCrossValidationTests`** — Compares the latest month's snapshots against Stripe's live subscription API. Requires `STRIPE_SECRET_KEY` in `.env`.

| Test | What it checks |
|------|----------------|
| `test_plan_matches_stripe` | Snapshot plan tier matches Stripe's current price for each subscription |
| `test_quantity_matches_stripe` | Snapshot screen count matches Stripe's subscription quantity |
| `test_mrr_matches_stripe` | Snapshot `mrr_cents` matches `unit_amount * quantity` from Stripe |
| `test_total_mrr_matches_stripe` | Aggregate MRR across all snapshots matches the sum from Stripe |

### When to run

| Moment | Which tests | Why |
|--------|-------------|-----|
| After `generate_data.py` | All | Confirm the pipeline produced correct data that matches Stripe |
| After modifying snapshot logic | All | Catch regressions |
| Before `extract_load.py` | Integrity tests | Don't load bad data into BigQuery |

### Skip behavior

Tests auto-skip gracefully when prerequisites aren't met:

- **No `sub_snapshots.json`**: All tests skip — run `generate_data.py` first
- **No `STRIPE_SECRET_KEY`**: Only Stripe cross-validation tests skip; integrity tests still run

## Re-running

- **`seed_prices.py`** — Only run once. Products/prices persist in Stripe.
- **`generate_data.py`** — Deletes all existing test clocks before creating new ones. Safe to re-run.
- **`extract_load.py`** — Uses `WRITE_TRUNCATE` so it's idempotent. Safe to re-run anytime.
